
  <h5 class="card-title">Death Causes</h5>
  <p, style="font-size: 16px;">
  In this pie chart is possible to see the main causes of death in a country and their % of deaths caused compared to the total.
On the bottom of the chart a year slider and a country selection button are present, by clicking and dragging the slider it's possible to change the year visualized and by selecting a different country the chart will visualize data related to that country.
</p>
<select id="CountryButton"></select>
  <div id="container_5"></div>


<!-- Include d3 library -->
<script src="https://d3js.org/d3.v7.min.js"></script>
                      <!-- Load slider -->
                      <script src="https://unpkg.com/d3-simple-slider"></script>
<!-- Create a container to host the chart -->



<style>
* {
      font-family: Verdana;
      font-size: 18px;
      line-height: 1.5;
      max-width: 700px; 
      margin: 0 auto; 
    }

    h5 {
padding-top: 20px;
    }

  text {
    font-family: lato;
    font-size: 10px;
    fill: #333333;
  }
  text.chart-title {
    font-size: 14px;
    font-weight: bold;
    fill:#222222
  }
  text.chart-source {
    font-size: 8px;
    fill: #999999;
  }
  text.copyright {
    font-size: 8px;
    fill: #999999;
  }
  .tooltip {
    background-color: #ffffff;
    font-family: lato;
    font-size: 11px;
    padding: 4px;
    color: #666666;
    border: none;
    box-shadow: 0px 0px 3px 0px #E6E6E6;
  }
</style>

<script>
// set the dimensions and margins of the graph

const margin5 = {top: 80, right: 80, bottom: 80, left: 80};
      height5 = 450,
      width5 = 450

// append the svg object to the body of the page
const svg = d3.select("#container_5")
  .append("svg")
    .attr("width", "100%")
    .attr("height", "50%")
    .attr("viewBox", "0 0 400 400")
    .attr("preserveAspectRatio", "xMinYMin")
  .append("g")
    .attr("transform", `translate(${width5 / 2}, ${height5 / 2})`);

    var Year=1990
    var Country="Afghanistan"
    


  const radius = Math.min(width5, height5) / 2 - margin5.top

// parse the Data
//d3.csv("https://raw.githubusercontent.com/GDS-ODSSS/unhcr-dataviz-platform/master/data/part_to_a_whole/pie.csv")
d3.csv("https://raw.githubusercontent.com/guidovalla/DV_project/main/data/2_3_pie.csv")

.then(function(data){

  fdata  = data.filter(function (d) {
      return d.year == Year;
    });
  //list of unique locations
  var map = new Map();
  var countries = [];
  for (const item of data) {
      if(!map.has(item.location)){
          map.set(item.location, true);    // set any value to Map
          countries.push({
              Country: item.location
          });
      }
  }
  countries=countries.map(d=>d.Country)
  countries=countries.filter(d=>d!="")
  countries=countries.sort()


      // Initialize a Dropdown
      d3.select("#CountryButton")
                      .selectAll('myOptions')
                      .data(countries)
                      .enter()
                      .append('option')
                      .attr("value", d =>d) // corresponding value returned by the button
                      .text(d=>d)
                      
                      fdata  = fdata.filter(function (d) {
      return d.location == Country;
    });


// color palette
const color = d3.scaleOrdinal()
  .domain(fdata)
  //.range(["#0072BC","#8EBEFF"])
  .range(["#009999"])
//"#00e6e6", "#00ffff"	
  //"#006666","#008080","#009999","", "	#1affff", "#33ffff","#95edeb","	#94d1d1","#295656",,"	
//"#003333","#004d4d"
//#0d7373"
// "#364949" ,"#1c4a4a"
 



const pie = d3.pie()
  .value(d => +d.val)
  .sort(null)

  fdata.sort((a, b) => b.val - a.val);
 
const dataPrepared = pie(fdata);


arc = d3.arc()
  .innerRadius(0)
  .outerRadius(radius)

data.forEach(function(d) {
  d.val = +d.val;
  d.enabled = true;
});

var total = d3.sum(fdata.map(function(d) {
  return (d.enabled) ? d.val : 0;
  }));

// create a tooltip
const tooltip = d3.select("body")
  .append("div")
    .attr("class", "tooltip");

// tooltip events
const mouseover = function(d) {
  tooltip
      .style("opacity", 1)
  d3.select(this)
      .style("opacity", .5)
};
const mousemove = function(event,d) {
  //var percent = Math.round(1000 * d.data.val/ total) / 10;
  const f = d3.format(",.0f");
  tooltip
  .html(`<b>${d.data.cause}</b>: `+  Math.round(1000 * d.data.val/ total) / 10 + '%')
  .style("left", (d3.pointer(event)[0])*1.2+260 + "px")
      .style("top", (d3.pointer(event)[1])*1.2+260 + "px")
      .style("position", "absolute")
};
const mouseleave = function(d) {
  tooltip
    .style("opacity", 0)
  d3.select(this)
  .style("stroke", "#000000")
    .style("opacity", 1)
};

svg
.selectAll('path')
.data(dataPrepared)
.join('path')
  .attr('d', arc)
  .attr('fill', d => color(d.data.cause))
  .attr("stroke", "#000000")
  .style("stroke-width", "2px")
  .each(function(d) { this._current - d; })
  .on("mouseover", mouseover)
  .on("mousemove", mousemove)
  .on("mouseleave", mouseleave);

svg
  .append("g")
  // .attr("class", "text-elements")
  .attr("text-anchor", "middle")
  .selectAll("text")
  .data(dataPrepared)
  .join("text")
  .attr("transform", d => `translate(${arc.centroid(d)})`)
  .call(text => text.append("tspan")
    .attr("x", "0.2em")
    .attr("y", "-0.6em")
    .attr("fill", "white")
    .style("font-size", "10px")
    .text(d => d.data.cause))
    .call(text => text.filter(d => (d.endAngle - d.startAngle) > 0.1).append("tspan")
    .attr("x", 0)
    .attr("y", "0.7em")
    .attr("fill", "white")
    .style("font-size", "10px")
    .text(d => Math.round(1000 * d.data.val/ total) / 10 + '%'))
    .attr('opacity', d => (d.endAngle-d.startAngle)<0.75 ? 0:0.99)
    // .attr("class", "chartElement");

  //add slider 
          
  const sliderRange= d3
  .sliderBottom()
  .min(1990)
  .max(2019)
  .width(600)
  .step(1)
  .tickFormat(d3.format('Y'))
  .ticks(5)
  .default(1990)
  .on('onchange', val => {
      Year = val
        updateChart(Year, Country)
      })



  d3.select("#CountryButton").on("change", function () {
                      Country = d3.select(this).property("value");
                      updateChart(Year, Country);
                  });
          const gRange= d3.
          select('#container_5')
          .append("svg")
          .attr("width", 600 + margin5.left + margin5.right)
          .attr("height", 50 + margin5.top + margin5.bottom)
          .append("g")
          .attr("transform","translate(" + margin5.left + "," + margin5.top + ")")
          .call(sliderRange);



          function updateChart(Year, Country){
            //remove the tspan text
            svg.selectAll("tspan").remove();


         
  fdata  = data.filter(function (d) {
      return d.year == Year;
    });


    fdata  = fdata.filter(function (d) {
      return d.location == Country;
    });


    fdata.sort((a, b) => b.val - a.val);



   const dataPrepared = pie(fdata)
console.log("data", dataPrepared)

arc = d3.arc()
  .innerRadius(0)
  .outerRadius(radius)

  fdata.forEach(function(d) {
      d.val = +d.val;
      d.enabled = true;
    });
  
  total = d3.sum(fdata.map(function(d) {
    return (d.enabled) ? d.val : 0;  }));


    svg
.selectAll('path')
.data(dataPrepared)
.join('path')
  .attr('d', arc)
  .attr('fill', d => color(d.data.cause))
  .attr("stroke", "#000000")
  .style("stroke-width", "2px")
  .each(function(d) { this._current - d; })
  .on("mouseover", mouseover)
  .on("mousemove", mousemove)
  .on("mouseleave", mouseleave);

svg
  .append("g")
  .attr("text-anchor", "middle")
  .selectAll("text")
  .data(dataPrepared)
  .join("text")
  .attr("transform", d => `translate(${arc.centroid(d)})`)
  .call(text => text.append("tspan")
    .attr("x", "0.2em")
    .attr("y", "-0.6em")
    .attr("fill", "white")
    .style("font-size", "10px")
    .text(d => d.data.cause))
  .call(text => text.filter(d => (d.endAngle - d.startAngle) > 0.25).append("tspan")
    .attr("x", 0)
    .attr("y", "0.7em")
    .attr("fill", "white")
    .style("font-size", "10px")
    .text(d => Math.round(1000 * d.data.val/ total) / 10 + '%'))
    .attr('opacity', d => (d.endAngle-d.startAngle)<0.75 ? 0:1)
   
  }
})



</script>