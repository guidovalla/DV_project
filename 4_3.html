<!DOCTYPE html>
<meta charset="utf-8">
<!-- Include d3 library -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<!-- Load slider -->
<script src="https://unpkg.com/d3-simple-slider"></script>


<!-- Create a container to host the chart -->
<div id="viz_container"></div>
<div id="slider-range"></div>



<style>
    svg {
  width: 300;
  height: 300;
}
text {
  font-family: lato;
  font-size: 10px;
  fill: #333333;
}
.grid path {
  stroke-width: 0;
  stroke: #333333;
}
.grid .tick line {
  stroke: #333333;
  stroke-width: 0.3px;
  stroke-opacity: 0.3;
}
text.chart-label {
  font-size: 10px;
  font-weight: 400;
  fill: #999999;
}
.tooltip {
  background-color: #ffffff;
  font-family: lato;
  font-size: 11px;
  padding: 4px;
  color: #666666;
  border: none;
  box-shadow: 0px 0px 3px 0px #E6E6E6;
}
.legend{
  font-size: 10px;
}
</style>

<script>
// set the dimensions and margins of the graph
const margin = {top: 60, right: 20, bottom: 50, left: 60};
  const width = 450 - margin.left - margin.right;
  const height = 350 - margin.top - margin.bottom;

  // append the svg object to the body of the page
  const svg = d3.select("#viz_container")
    .append("svg")
      .attr("width", "300")
      .attr("height", "200")
      .attr("viewBox", "0 0 450 350")
      .attr("preserveAspectRatio", "xMinYMin")
    .append("g")
      .attr("transform", `translate(${margin.left}, ${margin.top})`);

  // parse the Data
  d3.csv("https://raw.githubusercontent.com/guidovalla/DV_project/main/data/4_3_new.csv")
  .then(function(data){

    var uniqueYearsSet = new Set(data.map(d => d.Year));
    var allYears = Array.from(uniqueYearsSet);
    console.log("years", allYears)


    

d3.select("#YearsButton")
          .selectAll('myOptions')
             .data(allYears)
            .enter()
            .append('option')
          .text(function (d) { return d; }) // text showed in the menu
          .attr("value", function (d) { return d; }) // corresponding value returned by the button


  // X scale and Axis
  const xScaleMale = d3.scaleLinear()
    .domain([0, 1.2*d3.max(data, d => +d.male)])
    .range([width/2, 0]);
  svg
    .append("g")
        .attr("transform", `translate(0, ${height})`)
    .call(d3.axisBottom(xScaleMale).tickSize(0).tickPadding(3).ticks(7, ""))
    .call(function(d) { return d.select(".domain").remove()});

  const xScaleFemale = d3.scaleLinear()
    .domain([0, 1.2* d3.max(data, d => +d.female)])
    .range([width/2, width]);
  svg
    .append("g")
        .attr("transform", `translate(0, ${height})`)
    .call(d3.axisBottom(xScaleFemale).tickSize(0).tickPadding(3).ticks(7, ""))
    .call(function(d) { return d.select(".domain").remove()});

  // set vertical grid line
  const GridLineF = function() { return d3.axisBottom().scale(xScaleFemale)};
  svg
    .append("g")
      .attr("class", "grid")
    .call(GridLineF()
      .tickSize(height,0,0)
      .tickFormat("")
      .ticks(7)
  );
  const GridLineM = function() { return d3.axisBottom().scale(xScaleMale)};
  svg
    .append("g")
      .attr("class", "grid")
    .call(GridLineM()
      .tickSize(height,0,0)
      .tickFormat("")
      .ticks(7)
  );

  // Y scale and Axis
  const yScale = d3.scaleBand()
      .domain(data.map(d => d.ages))
      .range([height, 0])
      .padding(.25);
  svg
      .append("g")
      .call(d3.axisLeft(yScale).tickSize(0).tickPadding(15))
      .call(d => d.select(".domain").remove());

  // create a tooltip
  const tooltip = d3.select("body")
    .append("div")
      .attr("class", "tooltip");

  // tooltip events
  const mouseover = function(d) {
      tooltip
        .style("opacity", 1)
      d3.select(this)
        .style("stroke", "#EF4A60")
        .style("opacity", .5)
  };
  const mousemove1 = function(event,d) {

      tooltip
      .html( `${d3.format(".2f")(d.male)}  Billions`)
        .style("top", event.pageY - 10 + "px")
        .style("left", event.pageX + 10 + "px");
  };
  const mousemove2 = function(event,d) {
    tooltip
    .html(`${d3.format(".2f")(d.female)}  Billions`)
      .style("top", event.pageY - 10 + "px")
      .style("left", event.pageX + 10 + "px")
};
  const mouseleave = function(d) {
      tooltip
        .style("opacity", 0)
      d3.select(this)
        .style("stroke", "none")
        .style("opacity", 1)
  };

  var Pippo = "2023"

  var dataFilter = data.filter(function(d){return d.Year==Pippo})

  // create male bars
  svg
    .selectAll(".maleBar")
      .data(dataFilter)
    .join("rect")
      .attr("class", "barMale")
      .attr("x", d => xScaleMale(d.male))
      .attr("y", d => yScale(d.ages))
      .attr("width", d => width/2 - xScaleMale(d.male))
      .attr("height", yScale.bandwidth())
      .style("fill", "#18375F")
    .on("mouseover", mouseover)
    .on("mousemove", mousemove1)
    .on("mouseleave", mouseleave)

  // create female bars
  svg
      .selectAll(".femaleBar")
        .data(dataFilter)
      .join("rect")
        .attr("class", "barFemale")
        .attr("x", xScaleFemale(0))
        .attr("y", d => yScale(d.ages))
        .attr("width", d => xScaleFemale(d.female) - xScaleFemale(0))
        .attr("height", yScale.bandwidth())
        .style("fill", "#0072BC")
      .on("mouseover", mouseover)
      .on("mousemove", mousemove2)
      .on("mouseleave", mouseleave)

  // set x axis label
  svg
      .append("text")
          .attr("class", "chart-label")
          .attr("x", width/3.5)
          .attr("y", height + margin.bottom/1.5)
      .text("Population (billions)")

  //set legend
  svg
      .append("rect")
          .attr("x", -(margin.left)*0.7)
          .attr("y", -(margin.top/3))
          .attr("width", 13)
          .attr("height", 13)
          .style("fill", "#18375F")
  svg
      .append("text")
          .attr("class", "legend")
          .attr("x", -(margin.left)*0.6+15)
          .attr("y", -(margin.top/5.5))
      .text("Male")
  svg
      .append("rect")
          .attr("x", 40)
          .attr("y", -(margin.top/3))
          .attr("width", 13)
          .attr("height", 13)
          .style("fill", "#0072BC")
  svg
      .append("text")
          .attr("class", "legend")
          .attr("x", 60)
          .attr("y", -(margin.top/5.5))
      .text("Female")

         //add slider 
        
         const sliderRange= d3
.sliderBottom()
.min(2023)
.max(2100)
.width(200)
.step(1)
.tickFormat(d3.format('Y'))
.ticks(5)
.default(2023)
.on('onchange', val => {
    Pippo = val
      update(Pippo)
    })
        const gRange= d3.
        select('#slider-range')
        .append("svg")
        .attr("width", 200+ margin.left + margin.right)
        .attr("height", 40+ margin.bottom)
        .append("g")
        .attr("transform","translate(" + margin.right+ "," + margin.bottom + ")")
        .call(sliderRange);




      function update(selectedYear) {
  // Remove existing bars
  svg.selectAll(".barMale").remove();
  svg.selectAll(".barFemale").remove();

  // Filter data for the selected year
  const dataFilter = data.filter(function (d) {
    return d.Year == selectedYear;
  });

  // Update male bars
  svg
    .selectAll(".maleBar")
    .data(dataFilter)
    .enter()
    .append("rect")
    .attr("class", "barMale")
    .attr("x", (d) => xScaleMale(d.male))
    .attr("y", (d) => yScale(d.ages))
    .attr("width", (d) => width / 2 - xScaleMale(d.male))
    .attr("height", yScale.bandwidth())
    .style("fill", "#18375F")
    .on("mouseover", mouseover)
    .on("mousemove", mousemove1)
    .on("mouseleave", mouseleave);

  // Update female bars (similar code as above)
  svg
    .selectAll(".femaleBar")
    .data(dataFilter)
    .enter()
    .append("rect")
    .attr("class", "barFemale")
    .attr("x", xScaleFemale(0))
    .attr("y", (d) => yScale(d.ages))
    .attr("width", (d) => xScaleFemale(d.female) - xScaleFemale(0))
    .attr("height", yScale.bandwidth())
    .style("fill", "#0072BC")
    .on("mouseover", mouseover)
    .on("mousemove", mousemove2)
    .on("mouseleave", mouseleave);
}


  
  d3.select("#YearsButton").on("change", function(d) {
    Pippo = d3.select(this).property("value")
    update(Pippo)
  })

  })



  

</script>