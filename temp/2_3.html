<!DOCTYPE html>
<meta charset="utf-8">
<!-- Include d3 library -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- Create a container to host the chart -->
<div id="viz_container"></div>

<!-- Load slider -->
<script src="https://unpkg.com/d3-simple-slider"></script>

<div id="slider-range"></div>
    <!-- Initialize a Dropdown -->
    <select id="CountryButton"></select>



<style>
svg {
    width: 100%;
    height: 100%;
  }
  text.chart-title {
    font-size: 14px;
    font-weight: bold;
    fill:#222222
  }
  text.chart-source {
    font-size: 8px;
    fill: #999999;
  }
  text.copyright {
    font-size: 8px;
    fill: #999999;
  }
  .tooltip {
    background-color: #ffffff;
    font-family: lato;
    font-size: 11px;
    padding: 4px;
    color: #666666;
    border: none;
    box-shadow: 0px 0px 3px 0px #E6E6E6;
  }
</style>

<script>

// set the dimensions and margins of the graph
const margin = {top: 30, right: 20, bottom: 30, left: 20};
const width = 450 - margin.left - margin.right;
const height = 350 - margin.top - margin.bottom;

// append the svg object to the body of the page
const svg = d3.select("#viz_container")
  .append("svg")
    .attr("width", "100%")
    .attr("height", "100%")
    .attr("viewBox", "0 0 450 350")
    .attr("preserveAspectRatio", "xMinYMin")
  .append("g")
    .attr("transform", `translate(${margin.left}, ${margin.top})`);

    var Year=1990
    
// parse the Data
//d3.csv("https://raw.githubusercontent.com/GDS-ODSSS/unhcr-dataviz-platform/master/data/part_to_a_whole/treemap_d3.csv")
d3.csv("https://raw.githubusercontent.com/guidovalla/DV_project/main/data/2_3.csv")

.then(function(data){

  d3.select("#CountryButton")
                    .selectAll('myOptions')
                    .data(d3.map(data, function(d){return d.location;}))
                    .enter()
                    .append('option')
                    .text((d) => d) // text showed in the menu
                    .attr("value", (d) => d) // corresponding value returned by the button

  fdata  = data.filter(function (d) {
    return d.year == Year;
  });

  //append a row to fdata
  fdata.push({parent: "", cause: "root", val: ""})



fdata.forEach(function(d) {
    d.val = +d.val;
    d.enabled = true;
  });

const total = d3.sum(fdata.map(function(d) {
  return (d.enabled) ? d.val : 0;  }));

// reshape fdata
const treeData = d3.stratify()
  .id(d => d.cause)
  .parentId(d => d.parent)
  (fdata);


treeData.sum(d => d.val)

//sort treedata on value
treeData.sort(function(a, b) { return b.height - a.height || b.value - a.value; });

d3.treemap()
  .size([width, height])
  .padding(2)
  (treeData);

// create a tooltip
const tooltip = d3.select("body")
  .append("div")
    .attr("class", "tooltip");

// tooltip events
const mouseover = function(d) {
  tooltip
      .style("opacity", 1)
  d3.select(this)
      .style("opacity", .5)
};
const mousemove = function(event,d) {
  f = d3.format(",")
  tooltip
  
  .html("Percentage: " + (d.data.val/10).toFixed(2)+ "%")

    .style("top", event.pageY - 10 + "px")
    .style("left", event.pageX + 10 + "px")
};
const mouseleave = function(d) {
  tooltip
    .style("opacity", 0)
  d3.select(this)
    .style("stroke", "none")
    .style("opacity", 1)
};

// create rectangle
console.log("data", treeData.leaves())

svg
  .selectAll("rect")
  .data(treeData.leaves())
  .join("rect")
    .attr('x', d => d.x0)
    .attr('y', d => d.y0)
    .attr('width', d => d.x1 - d.x0)
    .attr('height', d=> d.y1 - d.y0)
    .style("stroke", "none")
    .style("fill", "#0072BC")
  .on("mouseover", mouseover)
  .on("mousemove", mousemove)
  .on("mouseleave", mouseleave);

// add labels to the graph
svg
  .selectAll("text-number")
  .data(treeData.leaves())
  .join("text")
    .attr("class", "tree-label")
    .attr("x", d => d.x0+5)
    .attr("y", d => d.y0+15)
    //.text(d => Math.round(1000 * d.data.val / total) / 10 + "%")
    .text(d => (d.data.val/10).toFixed(2)+ "%")
    .attr("font-size", "5px")
    .attr("fill", "#ffffff");
svg
  .selectAll("text-region")
  .data(treeData.leaves())
  .join("text")
    .attr("class", "tree-label")
    .attr("x", d => d.x0+5)
    .attr("y", d => d.y0+30)
    .text(d => d.data.cause)
    .attr("font-size", "4px")
    .attr("fill", "#ffffff");

// set title
svg
  .append("text")
    .attr("class", "chart-title")
    .attr("x", 0)
    .attr("y", -(margin.top)/1.5)
    .attr("text-anchor", "start")
  .text("UNHCR global workforce by region | 2021");

// set source
svg
  .append("text")
    .attr("class", "chart-source")
    .attr("x", 0)
    .attr("y", height + margin.bottom*0.4)
    .attr("text-anchor", "start")
  .text("Source: UNHCR")

// set copyright
svg
  .append("text")
    .attr("class", "copyright")
    .attr("x", 0)
    .attr("y", height + margin.bottom*0.7)
    .attr("text-anchor", "start")
  .text("©UNHCR, The UN Refugee Agency")

//add slider 
        
const sliderRange= d3
.sliderBottom()
.min(1990)
.max(2021)
.width(300)
.step(1)
.tickFormat(d3.format('Y'))
.ticks(5)
.default(2021)
.on('onchange', val => {
    year = val
      updateChart(year)
    })
        const gRange= d3.
        select('#slider-range')
        .append("svg")
        .attr("width", 700 + margin.left + margin.right)
        .attr("height", 200 + margin.top + margin.bottom)
        .append("g")
        .attr("transform","translate(" + margin.left + "," + margin.top + ")")
        .call(sliderRange);

function updateChart(Year){
//remove all the bubbles
d3.selectAll("rect").remove()
//filter the data
fdata  = data.filter(function (d) {
    return d.year == Year;
  });

//append a row to fdata
fdata.push({parent: "", cause: "root", val: ""})



fdata.forEach(function(d) {
    d.val = +d.val;
    d.enabled = true;
  });

const total = d3.sum(fdata.map(function(d) {
  return (d.enabled) ? d.val : 0;  }));

// reshape fdata
const treeData = d3.stratify()
  .id(d => d.cause)
  .parentId(d => d.parent)
  (fdata);

treeData.sum(d => d.val)
console.log("data", treeData)

//sort treedata on value
treeData.sort(function(a, b) { return b.height - a.height || b.value - a.value; });

d3.treemap()
  .size([width, height])
  .padding(2)
  (treeData);


svg
  .selectAll("rect")
  .data(treeData.leaves())
  .join("rect")
    .attr('x', d => d.x0)
    .attr('y', d => d.y0)
    .attr('width', d => d.x1 - d.x0)
    .attr('height', d=> d.y1 - d.y0)
    .style("stroke", "none")
    .style("fill", "#0072BC")
  .on("mouseover", mouseover)
  .on("mousemove", mousemove)
  .on("mouseleave", mouseleave);

  svg
  .selectAll("text-number")
  .data(treeData.leaves())
  .join("text")
    .attr("class", "tree-label")
    .attr("x", d => d.x0+5)
    .attr("y", d => d.y0+15)
    //.text(d => Math.round(1000 * d.data.val / total) / 10 + "%")
    .text(d => (d.data.val/10).toFixed(2)+ "%")
    .attr("font-size", "5px")
    .attr("fill", "#ffffff");
svg
  .selectAll("text-region")
  .data(treeData.leaves())
  .join("text")
    .attr("class", "tree-label")
    .attr("x", d => d.x0+5)
    .attr("y", d => d.y0+30)
    .text(d => d.data.cause)
    .attr("font-size", "4px")
    .attr("fill", "#ffffff");

// set title
svg
  .append("text")
    .attr("class", "chart-title")
    .attr("x", 0)
    .attr("y", -(margin.top)/1.5)
    .attr("text-anchor", "start")
  .text("UNHCR global workforce by region | 2021");

// set source
svg
  .append("text")
    .attr("class", "chart-source")
    .attr("x", 0)
    .attr("y", height + margin.bottom*0.4)
    .attr("text-anchor", "start")
  .text("Source: UNHCR")

// set copyright
svg
  .append("text")
    .attr("class", "copyright")
    .attr("x", 0)
    .attr("y", height + margin.bottom*0.7)
    .attr("text-anchor", "start")
  .text("©UNHCR, The UN Refugee Agency")

}
  })

</script>