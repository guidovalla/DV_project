<!DOCTYPE html>
<meta charset="utf-8">
<!-- Include d3 library -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- Create a container to host the chart -->
<div id="viz_container"></div>

<select id="CountryButton"></select>



<style>

* {
      font-family: Verdana;
      font-size: 18px;
      line-height: 1.5;
    }
text {
  font-family: lato;
  font-size: 10px;
  fill: #333333;
}
.grid path {
  stroke-width: 0;
  stroke: #333333;
}
.grid .tick line {
  stroke: #333333;
  stroke-width: 0.3px;
  stroke-opacity: 0.3;
}
text.chart-title {
  font-size: 14px;
  font-weight: bold;
  fill:#222222
}
text.chart-label {
  font-size: 10px;
  font-weight: 400;
  fill: #999999;
}
text.chart-source {
  font-size: 8px;
  fill: #999999;
}
text.copyright {
  font-size: 8px;
  fill: #999999;
}
.tooltip {
  background-color: #ffffff;
  font-family: lato;
  font-size: 11px;
  padding: 4px;
  color: #666666;
  border: none;
  box-shadow: 0px 0px 3px 0px #E6E6E6;
}
</style>


<script>
// set the dimensions and margins of the graph
const margin = {top: 50, right: 20, bottom: 50, left: 40};
const width = 450 - margin.left - margin.right;
const height = 350 - margin.top - margin.bottom;

// append the svg object to the body of the page
const svg = d3.select("#viz_container")
  .append("svg")
    .attr("width", "100%")
    .attr("height", "100%")
    .attr("viewBox", "0 0 450 350")
    .attr("preserveAspectRatio", "xMinYMin")
  .append("g")
    .attr("transform", `translate(${margin.left}, ${margin.top})`);


    var Country="Afghanistan"

// parse the Data
//d3.csv("https://raw.zgithubusercontent.com/GDS-ODSSS/unhcr-dataviz-platform/master/data/comparison/column.csv")
d3.csv("https://raw.githubusercontent.com/guidovalla/DV_project/main/data/1_4_1_histo.csv")
.then(function(data){


  var map = new Map();
  var countries = [];
  for (const item of data) {
      if(!map.has(item.Location)){
          map.set(item.Location, true);    // set any value to Map
          countries.push({
              Country: item.Location
          });
      }
  }
  countries=countries.map(d=>d.Country)
  countries=countries.filter(d=>d!="")
  countries=countries.sort()


        // Initialize a Dropdown
        d3.select("#CountryButton")
                      .selectAll('myOptions')
                      .data(countries)
                      .enter()
                      .append('option')
                      .attr("value", d =>d) // corresponding value returned by the button
                      .text(d=>d)
                      
                      fdata  = data.filter(function (d) {
      return d.Location == Country;
    });




// X scale and Axis
const xScale = d3.scaleBand()
  .domain(fdata.map(d => d.Age))
  .range([0, width])
  .padding(.1);
svg
  .append('g')
  .attr("transform", `translate(0, ${height})`)
  .call(d3.axisBottom(xScale).tickSize(0).ticks(5));

// Y scale and Axis
const formater =  d3.format("~s")
const yScale = d3.scaleLinear()
    .domain([0, 1.2*d3.max(fdata, d => +d.Value)])
    .range([height, 0]);
    console.log(fdata)  
svg
  .append('g')
  .call(d3.axisLeft(yScale).tickSize(0).tickPadding(6).tickFormat(formater))
  //.call(d => d.select(".domain").remove());

// set horizontal grid line
// const GridLine = () => d3.axisLeft().scale(yScale);
// svg
//   .append("g")
//     .attr("class", "grid")
//   .call(GridLine()
//     .tickSize(-width,0,0)
//     .tickFormat("")
// );

// create a tooltip
const tooltip = d3.select("body")
  .append("div")
    .attr("id", "chart")
    .attr("class", "tooltip");

// tolltip events
const mouseover = function(d) {
    tooltip
      .style("opacity", .8)
    d3.select(this)
      .style("opacity", .5)
}
const mousemove = function(event, d) {
  const formater =  d3.format(",")
    tooltip
      .html(formater(d.Value))
      .style("top", event.pageY - 10 + "px")
      .style("left", event.pageX + 10 + "px");
}
const mouseleave = function(d) {
    tooltip
      .style("opacity", 0)
    d3.select(this)
      .style("opacity", 1)
}

// Bars
const barGroup = svg.selectAll("rect")
  .data(fdata)
  .enter()
  .append("g")

barGroup
  .append("rect")
    .attr("class", "bar")
    .attr("fill", "#0072BC")
    .attr("x", d => xScale(d.Age))
    .attr("y", d => yScale(d.Value))
    .attr("width", xScale.bandwidth())
    .attr("height", d => height - yScale(d.Value))
  .on("mouseover", mouseover)
  .on("mousemove", mousemove)
  .on("mouseleave", mouseleave);

// set title
svg
  .append("text")
    .attr("class", "chart-title")
    .attr("x", -(margin.left)*0.9)
    .attr("y", -(margin.top)/1.5)
    .attr("text-anchor", "start")
  .text("Trend of global displaced number | 2011 - 2021")

// set Y axis label
svg
  .append("text")
    .attr("class", "chart-label")
    .attr("x", -(margin.left)*0.9)
    .attr("y", -(margin.top/4))
    .attr("text-anchor", "start")
  .text("Displaced population (millions)")

// set source
svg
  .append("text")
    .attr("class", "chart-source")
    .attr("x", -(margin.left)*0.9)
    .attr("y", height + margin.bottom*0.7)
    .attr("text-anchor", "start")
  .text("Source: UNHCR Refugee Data Finder")

// set copyright
svg
  .append("text")
    .attr("class", "copyright")
    .attr("x", -(margin.left)*0.9)
    .attr("y", height + margin.bottom*0.9)
    .attr("text-anchor", "start")
  .text("©UNHCR, The UN Refugee Agency")




  d3.select("#CountryButton").on("change", function () {
                      Country = d3.select(this).property("value");
                      updateChart(Country);
                  });







                  function updateChart(Country){
            d3.selectAll("rect").remove()
            //remove previous axis
            d3.selectAll("text").remove()
            d3.selectAll("class", "grid").remove()

            



            fdata  = data.filter(function (d) {
      return d.Location == Country;
    });

const xScale = d3.scaleBand()
  .domain(fdata.map(d => d.Age))
  .range([0, width])
  .padding(.1);
svg
  .append('g')
  .attr("transform", `translate(0, ${height})`)
  .call(d3.axisBottom(xScale).tickSize(0).ticks(5));

// Y scale and Axis
const formater =  d3.format("~s")
const yScale = d3.scaleLinear()
    .domain([0, 1.2*d3.max(fdata, d => +d.Value)])
    .range([height, 0]);
    console.log(fdata)  
svg
  .append('g')
  .call(d3.axisLeft(yScale).tickSize(0).tickPadding(6).tickFormat(formater))
  .call(d => d.select(".domain").remove());

// // set horizontal grid line
// const GridLine = () => d3.axisLeft().scale(yScale);
// svg
//   .append("g")
//     .attr("class", "grid")
//   .call(GridLine()
//     .tickSize(-width,0,0)
//     .tickFormat("")
// );


    const barGroup = svg.selectAll("rect")
  .data(fdata)
  .enter()
  .append("g")

barGroup
  .append("rect")
    .attr("class", "bar")
    .attr("fill", "#0072BC")
    .attr("x", d => xScale(d.Age))
    .attr("y", d => yScale(d.Value))
    .attr("width", xScale.bandwidth())
    .attr("height", d => height - yScale(d.Value))
  .on("mouseover", mouseover)
  .on("mousemove", mousemove)
  .on("mouseleave", mouseleave);




  // set title
svg
  .append("text")
    .attr("class", "chart-title")
    .attr("x", -(margin.left)*0.9)
    .attr("y", -(margin.top)/1.5)
    .attr("text-anchor", "start")
  .text("Trend of global displaced number | 2011 - 2021")

// set Y axis label
svg
  .append("text")
    .attr("class", "chart-label")
    .attr("x", -(margin.left)*0.9)
    .attr("y", -(margin.top/4))
    .attr("text-anchor", "start")
  .text("Displaced population (millions)")

// set source
svg
  .append("text")
    .attr("class", "chart-source")
    .attr("x", -(margin.left)*0.9)
    .attr("y", height + margin.bottom*0.7)
    .attr("text-anchor", "start")
  .text("Source: UNHCR Refugee Data Finder")

// set copyright
svg
  .append("text")
    .attr("class", "copyright")
    .attr("x", -(margin.left)*0.9)
    .attr("y", height + margin.bottom*0.9)
    .attr("text-anchor", "start")
  .text("©UNHCR, The UN Refugee Agency")


                  }




})

</script>